name: 🚀 Deploy OnCabito Bot

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: 🧪 Tests
    runs-on: ubuntu-latest

    steps:
    - name: 📦 Checkout Code
      uses: actions/checkout@v4

    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📋 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 🔍 Lint Code
      run: |
        pip install flake8
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: ✅ Test Configuration
      run: |
        python -c "
        import sys
        sys.path.append('src')
        try:
            from sentinela.core.config import get_env_var
            print('✅ Config module loaded successfully')
        except ImportError as e:
            print(f'❌ Config import failed: {e}')
            sys.exit(1)
        "

  deploy:
    name: 🚀 Deploy to Server
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: 📦 Checkout Code
      uses: actions/checkout@v4

    - name: 🔐 Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 🌐 Deploy to Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
          # Navegar para o diretório do projeto
          cd ${{ secrets.DEPLOY_PATH }}

          # Backup do .env atual
          cp .env .env.backup

          # Pull das mudanças
          git pull origin main

          # Parar container atual
          docker stop oncabito-bot || true
          docker rm oncabito-bot || true

          # Rebuild da imagem
          docker build -t oncabito-bot .

          # Subir novo container
          docker run -d \
            --name oncabito-bot \
            --restart unless-stopped \
            --env-file .env \
            -v $(pwd)/data:/app/data \
            -v $(pwd)/logs:/app/logs \
            oncabito-bot

          # Verificar se subiu
          sleep 10
          docker ps | grep oncabito-bot

          # Logs inicial
          echo "🤖 OnCabito Bot deployed successfully!"
          docker logs oncabito-bot --tail 20
        '